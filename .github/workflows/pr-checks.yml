name: PR Checks

# TODO: The following items should be updated :
# - Secrets, Variables, Environment Variables
# - Deployment Environments
# - Checkov Skip Checks @ .checkov_skip_checks

on:
  pull_request:
    branches:
      - develop
      - main

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1

jobs:
  terraform-checks:
    name: Terraform Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"

      - name: Terraform Format
        run: |
          echo "ðŸ” Running Terraform format check..."
          terraform fmt -check -recursive
          echo "âœ… Terraform format check completed"
        continue-on-error: true

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.DEV_ASSUME_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.AWS_DEV_STATE_BUCKET }}" \
            -backend-config="key=dev/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.AWS_DEV_LOCK_TABLE }}" \
            -backend-config="workspace_key_prefix=${{ vars.WORKSPACE_KEY_PREFIX }}"

      - name: Terraform Validate
        run: |
          echo "ðŸ” Running Terraform validation..."
          terraform validate
          echo "âœ… Terraform validation completed"

      - name: Terraform Plan
        run: terraform plan -var-file=environments/dev.tfvars 

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: plan.txt

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.48.0

      - name: TFLint Check
        run: |
          echo "ðŸ” Running TFLint checks..."
          tflint --init
          echo "âœ… TFLint initialization completed"
          tflint
          echo "âœ… TFLint checks completed"

      - name: Setup Checkov
        run: |
          echo "ðŸš€ Setting up Checkov..."
          python -m pip install --upgrade pip
          pip install checkov
          echo "âœ… Checkov setup completed"

      - name: Checkov Scan
        run: |
          echo "ðŸ” Determining target environment..."
          if [ "${{ github.base_ref }}" = "develop" ]; then
            VAR_FILE="environments/dev/terraform.tfvars"
            echo "ðŸ“ Using dev environment variables"
          elif [ "${{ github.base_ref }}" = "main" ]; then
            VAR_FILE="environments/qa/terraform.tfvars"
            echo "ðŸ“ Using qa environment variables"
          fi

          CHECKOV_SKIP_CHECKS=$(cat ..checkov_skip_checks)
          echo "ðŸ” Skipping checks: $CHECKOV_SKIP_CHECKS"
          
          echo "ðŸ” Starting Checkov scan with var file: $VAR_FILE"
          checkov -d . \
            --framework terraform \
            --framework terraform_plan \
            --framework secrets \
            --compact \
            --quiet \
            --output cli \
            --soft-fail \
            --check "CKV_AWS_*" \
            --skip-check $CHECKOV_SKIP_CHECKS \
            --var-file=$VAR_FILE
          echo "âœ… Checkov scan completed"

      - name: Checkov SARIF Report
        run: |
          echo "ðŸ” Determining target environment..."
          if [ "${{ github.base_ref }}" = "develop" ]; then
            VAR_FILE="environments/dev/terraform.tfvars"
            echo "ðŸ“ Using dev environment variables"
          elif [ "${{ github.base_ref }}" = "main" ]; then
            VAR_FILE="environments/qa/terraform.tfvars"
            echo "ðŸ“ Using qa environment variables"
          fi
          CHECKOV_SKIP_CHECKS=$(cat ..checkov_skip_checks)
          checkov -d . \
            --framework terraform \
            --framework terraform_plan \
            --framework secrets \
            --output sarif \
            --soft-fail \
            --check "CKV_AWS_*" \
            --skip-check $CHECKOV_SKIP_CHECKS \
            --var-file=$VAR_FILE > checkov.sarif
      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: checkov.sarif
        continue-on-error: true