name: PR Checks

# TODO: The following items should be updated :
# - Secrets, Variables, Environment Variables
# - Deployment Environments
# - Checkov Skip Checks @ .checkov_skip_checks

on:
  pull_request:
    branches:
      - develop
      - main

permissions:
  id-token: write
  contents: read
  security-events: write

env:
  AWS_REGION: us-east-1

jobs:
  terraform-checks:
    name: Terraform Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"

      - name: Terraform Format
        run: |
          echo "üîç Running Terraform format check..."
          terraform fmt -check -recursive
          echo "‚úÖ Terraform format check completed"

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.DEV_ASSUME_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.AWS_DEV_STATE_BUCKET }}" \
            -backend-config="key=dev/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.AWS_DEV_LOCK_TABLE }}" \
            -backend-config="workspace_key_prefix=${{ vars.WORKSPACE_KEY_PREFIX }}"

      - name: Terraform Validate
        run: |
          echo "üîç Running Terraform validation..."
          terraform validate
          echo "‚úÖ Terraform validation completed"

      - name: Terraform Plan
        run: terraform plan -var-file=environments/dev.tfvars -out=plan.txt

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: plan.txt

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.48.0

      - name: TFLint Check
        run: |
          echo "üîç Running TFLint checks..."
          tflint --init
          echo "‚úÖ TFLint initialization completed"
          tflint
          echo "‚úÖ TFLint checks completed"

      - name: Setup Checkov
        run: |
          echo "üöÄ Setting up Checkov..."
          python -m pip install --upgrade pip
          pip install checkov
          echo "‚úÖ Checkov setup completed"

      - name: Checkov Scan
        run: |
          echo "üîç Determining target environment..."
          if [ "${{ github.base_ref }}" = "develop" ]; then
            VAR_FILE="environments/dev.tfvars"
            echo "üìÅ Using dev environment variables"
          elif [ "${{ github.base_ref }}" = "main" ]; then
            VAR_FILE="environments/qa.tfvars"
            echo "üìÅ Using qa environment variables"
          else
            echo "üîç No environment specified"
            VAR_FILE="environments/dev.tfvars"
            exit 1
          fi

          CHECKOV_SKIP_CHECKS=$(cat .checkov_skip_checks)
          echo "üîç Skipping checks: $CHECKOV_SKIP_CHECKS"
          
          echo "üîç Starting Checkov scan with var file: $VAR_FILE"
          checkov -d . \
            --framework terraform \
            --framework terraform_plan \
            --framework secrets \
            --compact \
            --quiet \
            --output cli \
            --soft-fail \
            --check "CKV_AWS_*" \
            --skip-check $CHECKOV_SKIP_CHECKS \
            --var-file=$VAR_FILE
          echo "‚úÖ Checkov scan completed"

      - name: Checkov SARIF Report
        run: |
          echo "üîç Determining target environment..."
          if [ "${{ github.base_ref }}" = "develop" ]; then
            VAR_FILE="environments/dev.tfvars"
            echo "üìÅ Using dev environment variables"
          elif [ "${{ github.base_ref }}" = "main" ]; then
            VAR_FILE="environments/qa.tfvars"
            echo "üìÅ Using qa environment variables"
          else
            echo "üîç No environment specified"
            VAR_FILE="environments/dev.tfvars"
            exit 1
          fi
          CHECKOV_SKIP_CHECKS=$(cat .checkov_skip_checks)
          checkov -d . \
            --framework terraform \
            --framework terraform_plan \
            --framework secrets \
            --output sarif \
            --soft-fail \
            --check "CKV_AWS_*" \
            --skip-check $CHECKOV_SKIP_CHECKS \
            --var-file=$VAR_FILE \
            --output-file-path checkov.sarif
      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif
        continue-on-error: true

      - name: Setup tfsec
        run: |
          echo "üöÄ Setting up tfsec..."
          curl -L -o tfsec https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-linux-amd64
          chmod +x tfsec
          sudo mv tfsec /usr/local/bin/
          echo "‚úÖ tfsec setup completed"

      - name: tfsec
        uses: aquasecurity/tfsec-pr-commenter-action@v1.2.0
        with:
          github_token: ${{ github.token }}
          tfsec_formats: sarif

      - name: Upload tfsec SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
        continue-on-error: true